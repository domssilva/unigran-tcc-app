from models import db
from models.user import User
from models.application import Application
from models.vulnerability import Vulnerability
from services.vulnerability_service import create_vulnerability, delete_vulnerability

def test_create_vulnerability(app):
    with app.app_context():
        # Cria usuário e aplicação
        user = User(name="Alice", email="alice@example.com")
        user.set_password("senha")
        db.session.add(user)
        db.session.commit()

        app_model = Application(name="AppSeguro", version="1.0", user_id=user.id)
        db.session.add(app_model)
        db.session.commit()

        # Cria vulnerabilidade vinculada
        vuln = create_vulnerability(
            description="SQL Injection na busca",
            severity="alta",
            status="aberto",
            application=app_model
        )

        assert isinstance(vuln, Vulnerability)
        assert vuln.description == "SQL Injection na busca"
        assert vuln.severity == "alta"
        assert vuln.status == "aberto"
        assert vuln.application_id == app_model.id

        # Verifica se contador de vulns da app aumentou
        assert app_model.vulnerabilities_count == 1

def test_delete_vulnerability(app):
    with app.app_context():
        # Cria usuário e app
        user = User(name="Joana", email="joana@example.com")
        user.set_password("123456")
        db.session.add(user)
        db.session.commit()

        app_model = Application(name="Sistema Interno", version="1.0", user_id=user.id)
        db.session.add(app_model)
        db.session.commit()

        # Cria duas vulnerabilidades
        v1 = create_vulnerability("Teste A", "baixa", "aberto", app_model)
        v2 = create_vulnerability("Teste B", "alta", "aberto", app_model)

        assert Vulnerability.query.count() == 2
        assert app_model.vulnerabilities_count == 2

        # Deleta uma
        delete_vulnerability(v1)

        assert Vulnerability.query.count() == 1
        assert app_model.vulnerabilities_count == 1
        assert Vulnerability.query.first().description == "Teste B"